<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Wizard Assistant</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        background-color: #f5f7fa;
        color: #333;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 20px;
      }
      .search-box {
        display: flex;
        margin-bottom: 20px;
      }
      .search-box input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px 0 0 4px;
        font-size: 16px;
      }
      .search-box button {
        padding: 10px 20px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 0 4px 4px 0;
        cursor: pointer;
        font-size: 16px;
      }
      .search-box button:hover {
        background-color: #2980b9;
      }
      .response-container {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-left: 4px solid #3498db;
        border-radius: 4px;
      }
      .email-list {
        margin-top: 20px;
      }
      .email-card {
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #fff;
      }
      .email-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      .email-subject {
        font-weight: bold;
        color: #2c3e50;
      }
      .email-metadata {
        color: #7f8c8d;
        font-size: 14px;
        margin-bottom: 10px;
      }
      .similarity-score {
        background-color: #3498db;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
      }
      .loading {
        text-align: center;
        margin: 20px 0;
        display: none;
      }
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .error-message {
        color: #e74c3c;
        padding: 10px;
        background-color: #fadbd8;
        border-radius: 4px;
        margin-bottom: 15px;
        display: none;
      }

      .alert {
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
      }

      .alert-info {
        color: #31708f;
        background-color: #d9edf7;
        border: 1px solid #bce8f1;
      }

      .alert-warning {
        color: #8a6d3b;
        background-color: #fcf8e3;
        border: 1px solid #faebcc;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Email Wizard Assistant</h1>

      <div class="search-box">
        <input
          type="text"
          id="query-input"
          placeholder="Ask a question about your emails..."
        />
        <button id="search-button">Search</button>
      </div>

      <div id="error-message" class="error-message"></div>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Processing your query...</p>
      </div>

      <div id="results" style="display: none">
        <div class="response-container">
          <h3>Assistant's Response:</h3>
          <p id="assistant-response"></p>
        </div>

        <div class="email-list">
          <h3>Retrieved Emails:</h3>
          <div id="email-container"></div>
        </div>
      </div>

      <div
        id="debug-section"
        style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px"
      >
        <h3>Debug Information</h3>
        <button id="test-api-button" style="margin-bottom: 10px">
          Test API Connection
        </button>
        <div
          id="debug-output"
          style="
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
          "
        ></div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const queryInput = document.getElementById("query-input");
        const searchButton = document.getElementById("search-button");
        const loading = document.getElementById("loading");
        const results = document.getElementById("results");
        const assistantResponse = document.getElementById("assistant-response");
        const emailContainer = document.getElementById("email-container");
        const errorMessage = document.getElementById("error-message");
        const testApiButton = document.getElementById("test-api-button");
        const debugOutput = document.getElementById("debug-output");

        // Sample query for testing
        queryInput.value = "What's the status of the project?";

        // Test API connection button
        testApiButton.addEventListener("click", async function () {
          debugOutput.textContent = "Testing API connection...";

          try {
            // Test root endpoint
            const rootResponse = await fetch("http://localhost:8000/", {
              method: "GET",
              mode: "cors",
              headers: {
                Accept: "application/json",
              },
            });

            const rootData = await rootResponse.json();
            debugOutput.textContent =
              "Root endpoint test:\n" +
              "Status: " +
              rootResponse.status +
              " " +
              rootResponse.statusText +
              "\n" +
              "Response: " +
              JSON.stringify(rootData, null, 2) +
              "\n\n";

            // Test health endpoint
            try {
              const healthResponse = await fetch(
                "http://localhost:8000/health",
                {
                  method: "GET",
                  mode: "cors",
                  headers: {
                    Accept: "application/json",
                  },
                }
              );

              const healthData = await healthResponse.json();
              debugOutput.textContent +=
                "Health endpoint test:\n" +
                "Status: " +
                healthResponse.status +
                " " +
                healthResponse.statusText +
                "\n" +
                "Response: " +
                JSON.stringify(healthData, null, 2);
            } catch (healthErr) {
              debugOutput.textContent +=
                "Health endpoint test failed:\n" + healthErr.message;
            }
          } catch (err) {
            debugOutput.textContent =
              "API connection test failed:\n" +
              err.message +
              "\n\nPossible reasons:\n" +
              "1. API server is not running\n" +
              "2. CORS is not properly configured\n" +
              "3. Network issue";
          }
        });

        searchButton.addEventListener("click", async function () {
          const query = queryInput.value.trim();

          if (!query) {
            showError("Please enter a query");
            return;
          }

          // Show loading, hide results and errors
          loading.style.display = "block";
          results.style.display = "none";
          errorMessage.style.display = "none";

          try {
            // Try to fetch from the API
            try {
              // First, check if the API is available with a simple GET request
              const checkResponse = await fetch("http://localhost:8000/", {
                method: "GET",
                mode: "cors",
                headers: {
                  Accept: "application/json",
                },
              });

              if (checkResponse.ok) {
                // API is available, make the actual query
                const response = await fetch(
                  "http://localhost:8000/query_email",
                  {
                    method: "POST",
                    mode: "cors",
                    headers: {
                      "Content-Type": "application/json",
                      Accept: "application/json",
                    },
                    body: JSON.stringify({ query }),
                  }
                );

                if (!response.ok) {
                  throw new Error(`Error: ${response.status}`);
                }

                const data = await response.json();
                console.log("API Response:", data);
                displayResults(data);
              } else {
                throw new Error("API not available");
              }
            } catch (apiErr) {
              console.warn(
                "API not available or CORS issue, using mock data:",
                apiErr
              );
              // If API fails, use mock data
              const mockData = getMockData(query);
              displayResults(mockData);
            }
          } catch (err) {
            showError(`Error: ${err.message}`);
          } finally {
            loading.style.display = "none";
          }
        });

        function displayResults(data) {
          // Display the assistant's response
          assistantResponse.textContent = data.response;

          // Clear previous emails
          emailContainer.innerHTML = "";

          // Log the data for debugging
          console.log("Response data:", data);

          if (data.retrieved_emails && data.retrieved_emails.length > 0) {
            console.log("First email object:", data.retrieved_emails[0]);
            debugOutput.textContent =
              "Email object structure:\n" +
              JSON.stringify(data.retrieved_emails[0], null, 2);
          }

          // Filter emails with match percentage > 50%
          const filteredEmails = data.retrieved_emails.filter(
            (email) => email.similarity_score * 100 > 50
          );

          // Update the heading to show filtered count
          const emailListHeading = document.querySelector(".email-list h3");
          if (emailListHeading) {
            emailListHeading.textContent = `Retrieved Emails (${filteredEmails.length} with >50% match)`;
          }

          // Display retrieved emails or a message if none meet the threshold
          if (filteredEmails.length === 0) {
            const noEmailsMessage = document.createElement("div");
            noEmailsMessage.className = "alert alert-info";
            noEmailsMessage.style.marginTop = "10px";
            noEmailsMessage.textContent =
              "No emails with match percentage greater than 50% were found.";
            emailContainer.appendChild(noEmailsMessage);
          }

          // Display retrieved emails
          filteredEmails.forEach((email) => {
            const emailCard = document.createElement("div");
            emailCard.className = "email-card";

            const similarityPercentage = (email.similarity_score * 100).toFixed(
              1
            );

            emailCard.innerHTML = `
                        <div class="email-header">
                            <div class="email-subject">${
                              email.metadata.subject
                            }</div>
                            <div class="similarity-score">${similarityPercentage}% Match</div>
                        </div>
                        <div class="email-metadata">
                            From: ${email.metadata.sender} | Date: ${
              email.metadata.date
            }
                        </div>
                        <div class="email-content">
                            ${
                              // First try content (from API)
                              email.content && email.content.trim()
                                ? email.content.substring(0, 200) +
                                  (email.content.length > 200 ? "..." : "")
                                : // Then try cleaned_text (from mock data)
                                email.cleaned_text && email.cleaned_text.trim()
                                ? email.cleaned_text.substring(0, 200) +
                                  (email.cleaned_text.length > 200 ? "..." : "")
                                : "No content available"
                            }
                        </div>
                    `;

            emailContainer.appendChild(emailCard);
          });

          // Show results
          results.style.display = "block";
        }

        function showError(message) {
          errorMessage.textContent = message;
          errorMessage.style.display = "block";
          loading.style.display = "none";
        }

        function getMockData(query) {
          return {
            query: query,
            response:
              "Based on the retrieved emails, the project is currently 25% complete in the development stage. The initial phase and design phase are 100% complete, while testing and deployment have not yet started. The team is on track to meet the deadline of June 15th.",
            retrieved_emails: [
              {
                id: "email_1",
                metadata: {
                  subject: "Project Status Update",
                  sender: "john.doe@example.com",
                  date: "Mon, 01 May 2023 10:00:00 +0000",
                },
                cleaned_text:
                  "Hi Jane, I wanted to provide an update on the current project status. We've completed the initial phase and are now moving into the development stage. The team has been working diligently to ensure all deliverables are met on time. Here's a summary of our progress: - Requirements gathering: 100% complete - Design phase: 100% complete - Development: 25% complete - Testing: Not started - Deployment: Not started We're currently on track to meet our deadline of June 15th.",
                similarity_score: 0.95,
              },
              {
                id: "email_2",
                metadata: {
                  subject: "Re: Project Status Update",
                  sender: "jane.smith@example.com",
                  date: "Mon, 01 May 2023 11:30:00 +0000",
                },
                cleaned_text:
                  "Hi John, Thank you for the update. I'm pleased to hear that we're on track with the project timeline. The progress looks good so far. I'd like to schedule a team meeting next week to discuss the development phase in more detail. How does Wednesday at 10 AM sound? Also, could you please share the latest design documents with the team?",
                similarity_score: 0.85,
              },
              {
                id: "email_9",
                metadata: {
                  subject: "New Client Opportunity",
                  sender: "alex.anderson@example.com",
                  date: "Wed, 10 May 2023 09:30:00 +0000",
                },
                cleaned_text:
                  "Hi John, I wanted to let you know about a potential new client opportunity. I met with representatives from Acme Corporation yesterday, and they're interested in our services for their upcoming project. They're looking for a partner to help them redesign their e-commerce platform, which aligns perfectly with our expertise.",
                similarity_score: 0.72,
              },
            ],
          };
        }
      });
    </script>
  </body>
</html>
